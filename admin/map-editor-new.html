<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图标记编辑器</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/map.css">
    <style>
        /* 编辑器特有样式 */
        .editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
        }

        .editor-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        /* 调整地图容器大小 */
        .map-container {
            height: 100vh;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .map-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        .map-wrapper.dragging {
            cursor: grabbing;
        }

        .map-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center center;
        }

        .map-image {
            max-width: none;
            max-height: none;
            width: auto;
            height: 80vh;
            object-fit: contain;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .panel-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .panel-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* 编辑模式下的标记样式 */
        .marker.editing {
            cursor: move;
            transform: translate(-50%, -100%) scale(1.2);
            z-index: 100;
        }

        .marker.editing .marker-icon {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .marker.editing .marker-pulse {
            background: rgba(231, 76, 60, 0.3);
        }

        /* 编辑工具栏 */
        .editor-toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 12px;
            z-index: 1001;
            width: 140px;
        }

        .toolbar-btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            background: #f8f9fa;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            white-space: nowrap;
        }

        .toolbar-btn:last-child {
            margin-bottom: 0;
        }

        .toolbar-btn:hover {
            background: #e9ecef;
        }

        .toolbar-btn.active {
            background: #3498db;
            color: white;
        }

        /* 坐标显示 */
        .coordinate-display {
            position: fixed;
            bottom: 20px;
            left: 310px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1001;
        }

        /* 网格辅助线 */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.3;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            display: none;
        }

        .grid-overlay.show {
            display: block;
        }

        /* 景点列表 */
        .attractions-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .attraction-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .attraction-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .attraction-item.selected {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .attraction-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .attraction-coords {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- 地图容器 - 复用H5端的结构 -->
    <div class="map-container">
        <!-- 渐变背景 -->
        <div class="map-background"></div>
        
        <!-- 手绘地图 -->
        <div class="map-wrapper" id="mapWrapper">
            <div class="map-content" id="mapContent">
                <!-- 网格辅助线 -->
                <div class="grid-overlay" id="gridOverlay"></div>
                
                <!-- 地图图片 -->
                <img class="map-image" id="mapImage" src="../assets/map.jpg" alt="旅游地图" draggable="false">
                
                <!-- 景点标记 - 动态生成 -->
                <div id="markersContainer">
                    <!-- 标记将通过JavaScript动态添加 -->
                </div>
            </div>
        </div>

        <!-- 地图控制按钮 - 复用H5端的控制 -->
        <div class="map-controls">
            <button class="control-btn" id="locateBtn" title="重置视图">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                </svg>
            </button>
            <button class="control-btn" id="zoomInBtn" title="放大">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </button>
            <button class="control-btn" id="zoomOutBtn" title="缩小">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M19 13H5v-2h14v2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 编辑工具栏 -->
    <div class="editor-toolbar">
        <button class="toolbar-btn" id="selectModeBtn">🎯 选择模式</button>
        <button class="toolbar-btn" id="addModeBtn">➕ 添加标记</button>
        <button class="toolbar-btn" id="gridToggleBtn">📐 显示网格</button>
        <button class="toolbar-btn" id="saveBtn">💾 保存更改</button>
        <button class="toolbar-btn" id="previewBtn">👁️ 预览H5</button>
        <button class="toolbar-btn" id="backBtn">🏠 返回后台</button>
    </div>

    <!-- 景点列表面板 -->
    <div class="editor-panel">
        <div class="panel-header">
            <h3 class="panel-title">景点管理</h3>
        </div>
        <div class="panel-content">
            <div class="form-group">
                <label class="form-label">景点列表</label>
                <div class="attractions-list" id="attractionsList">
                    <!-- 动态加载 -->
                </div>
            </div>
            
            <div id="editForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">景点名称</label>
                    <input type="text" class="form-input" id="attractionName" placeholder="请输入景点名称">
                </div>
                
                <div class="form-group">
                    <label class="form-label">景点描述</label>
                    <textarea class="form-textarea" id="attractionDescription" placeholder="请输入景点描述"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">图片URL</label>
                    <input type="text" class="form-input" id="attractionImage" placeholder="请输入图片URL">
                </div>
                
                <div class="form-group">
                    <label class="form-label">坐标位置</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" class="form-input" id="attractionX" placeholder="X%" style="flex: 1;">
                        <input type="number" class="form-input" id="attractionY" placeholder="Y%" style="flex: 1;">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="saveAttractionBtn">保存</button>
                    <button class="btn btn-secondary" id="cancelEditBtn">取消</button>
                    <button class="btn btn-danger" id="deleteAttractionBtn">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 坐标显示 -->
    <div class="coordinate-display" id="coordinateDisplay">
        坐标: (0, 0)
    </div>

    <script src="../js/common.js"></script>
    <script>
        // 地图编辑器类 - 基于H5端的MapApp进行扩展
        class MapEditor {
            constructor() {
                // 继承H5端的地图功能
                this.scale = 1;
                this.minScale = 0.5;
                this.maxScale = 3;
                this.translateX = 0;
                this.translateY = 0;
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                
                // 编辑器特有属性
                this.editMode = 'select'; // select, add
                this.selectedMarker = null;
                this.attractions = [];
                this.nextId = 1;
                
                this.init();
            }

            init() {
                this.loadAttractions();
                this.bindEvents();
                this.initMap();
                this.renderAttractions();
                this.updateMarkerScale();
            }

            // 加载景点数据
            loadAttractions() {
                // 从localStorage或API加载数据
                const saved = localStorage.getItem('attractions');
                if (saved) {
                    this.attractions = JSON.parse(saved);
                    this.nextId = Math.max(...this.attractions.map(a => a.id), 0) + 1;
                } else {
                    // 默认数据
                    this.attractions = [
                        {
                            id: 1,
                            name: '西湖',
                            description: '西湖，位于浙江省杭州市西湖区龙井路1号，杭州市区西部，景区总面积49平方千米。',
                            image: 'https://picsum.photos/300/150?random=11',
                            x: 25,
                            y: 30,
                            coordinates: { lat: 30.2741, lng: 120.1551 }
                        },
                        {
                            id: 2,
                            name: '灵隐寺',
                            description: '灵隐寺，又名云林寺，位于浙江省杭州市，背靠北高峰，面朝飞来峰。',
                            image: 'https://picsum.photos/300/150?random=12',
                            x: 45,
                            y: 25,
                            coordinates: { lat: 30.2408, lng: 120.1014 }
                        },
                        {
                            id: 3,
                            name: '宋城',
                            description: '杭州宋城景区是中国大陆人气最旺的主题公园，年游客逾700万人次。',
                            image: 'https://picsum.photos/300/150?random=13',
                            x: 60,
                            y: 45,
                            coordinates: { lat: 30.1957, lng: 120.0778 }
                        },
                        {
                            id: 4,
                            name: '河坊街',
                            description: '河坊街位于吴山脚下，是清河坊的一部分，属于杭州老城区。',
                            image: 'https://picsum.photos/300/150?random=14',
                            x: 35,
                            y: 60,
                            coordinates: { lat: 30.2467, lng: 120.1707 }
                        }
                    ];
                }
            }

            // 保存景点数据
            saveAttractions() {
                localStorage.setItem('attractions', JSON.stringify(this.attractions));
                alert('保存成功！');
            }

            // 渲染景点标记
            renderAttractions() {
                const container = document.getElementById('markersContainer');
                container.innerHTML = '';
                
                this.attractions.forEach(attraction => {
                    const marker = this.createMarker(attraction);
                    container.appendChild(marker);
                });
                
                this.renderAttractionsList();
            }

            // 创建标记元素
            createMarker(attraction) {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.dataset.id = attraction.id;
                marker.style.left = attraction.x + '%';
                marker.style.top = attraction.y + '%';
                
                marker.innerHTML = `
                    <div class="marker-pulse"></div>
                    <div class="marker-icon"></div>
                `;
                
                return marker;
            }

            // 渲染景点列表
            renderAttractionsList() {
                const list = document.getElementById('attractionsList');
                list.innerHTML = '';
                
                this.attractions.forEach(attraction => {
                    const item = document.createElement('div');
                    item.className = 'attraction-item';
                    item.dataset.id = attraction.id;
                    item.innerHTML = `
                        <div class="attraction-name">${attraction.name}</div>
                        <div class="attraction-coords">(${attraction.x}%, ${attraction.y}%)</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.selectAttraction(attraction.id);
                    });
                    
                    list.appendChild(item);
                });
            }

            // 选择景点
            selectAttraction(id) {
                this.selectedMarker = this.attractions.find(a => a.id === id);
                
                // 更新UI
                document.querySelectorAll('.attraction-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelector(`[data-id="${id}"]`).classList.add('selected');
                
                // 显示编辑表单
                this.showEditForm();
            }

            // 显示编辑表单
            showEditForm() {
                if (!this.selectedMarker) return;
                
                const form = document.getElementById('editForm');
                form.style.display = 'block';
                
                document.getElementById('attractionName').value = this.selectedMarker.name;
                document.getElementById('attractionDescription').value = this.selectedMarker.description;
                document.getElementById('attractionImage').value = this.selectedMarker.image;
                document.getElementById('attractionX').value = this.selectedMarker.x;
                document.getElementById('attractionY').value = this.selectedMarker.y;
            }

            // 隐藏编辑表单
            hideEditForm() {
                document.getElementById('editForm').style.display = 'none';
                this.selectedMarker = null;
                
                document.querySelectorAll('.attraction-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }

            // 绑定事件
            bindEvents() {
                const mapWrapper = document.getElementById('mapWrapper');
                const mapContent = document.getElementById('mapContent');
                
                // 地图拖拽和缩放事件（复用H5端逻辑）
                mapWrapper.addEventListener('mousedown', this.handleMouseDown.bind(this));
                document.addEventListener('mousemove', this.handleMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleMouseUp.bind(this));
                mapWrapper.addEventListener('wheel', this.handleWheel.bind(this), { passive: false });
                
                // 缩放控制
                document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
                document.getElementById('locateBtn').addEventListener('click', () => this.resetView());
                
                // 编辑工具栏
                document.getElementById('selectModeBtn').addEventListener('click', () => this.setEditMode('select'));
                document.getElementById('addModeBtn').addEventListener('click', () => this.setEditMode('add'));
                document.getElementById('gridToggleBtn').addEventListener('click', () => this.toggleGrid());
                document.getElementById('saveBtn').addEventListener('click', () => this.saveAttractions());
                document.getElementById('previewBtn').addEventListener('click', () => this.previewH5());
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                
                // 编辑表单
                document.getElementById('saveAttractionBtn').addEventListener('click', () => this.saveAttraction());
                document.getElementById('cancelEditBtn').addEventListener('click', () => this.hideEditForm());
                document.getElementById('deleteAttractionBtn').addEventListener('click', () => this.deleteAttraction());
                
                // 地图点击事件
                mapWrapper.addEventListener('click', this.handleMapClick.bind(this));
                
                // 鼠标移动显示坐标
                mapWrapper.addEventListener('mousemove', this.updateCoordinateDisplay.bind(this));
            }

            // 设置编辑模式
            setEditMode(mode) {
                this.editMode = mode;
                
                document.querySelectorAll('.toolbar-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (mode === 'select') {
                    document.getElementById('selectModeBtn').classList.add('active');
                } else if (mode === 'add') {
                    document.getElementById('addModeBtn').classList.add('active');
                }
            }

            // 处理地图点击
            handleMapClick(e) {
                if (this.editMode === 'add' && !this.isDragging) {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = ((e.clientX - rect.left - this.translateX) / this.scale / rect.width) * 100;
                    const y = ((e.clientY - rect.top - this.translateY) / this.scale / rect.height) * 100;
                    
                    this.addAttraction(x, y);
                }
            }

            // 添加景点
            addAttraction(x, y) {
                const newAttraction = {
                    id: this.nextId++,
                    name: `新景点${this.nextId - 1}`,
                    description: '请编辑景点描述',
                    image: 'https://picsum.photos/300/150?random=' + (this.nextId - 1),
                    x: Math.round(x * 10) / 10,
                    y: Math.round(y * 10) / 10,
                    coordinates: { lat: 30.2741, lng: 120.1551 }
                };
                
                this.attractions.push(newAttraction);
                this.renderAttractions();
                this.selectAttraction(newAttraction.id);
            }

            // 保存景点
            saveAttraction() {
                if (!this.selectedMarker) return;
                
                const name = document.getElementById('attractionName').value;
                const description = document.getElementById('attractionDescription').value;
                const image = document.getElementById('attractionImage').value;
                const x = parseFloat(document.getElementById('attractionX').value);
                const y = parseFloat(document.getElementById('attractionY').value);
                
                if (!name || isNaN(x) || isNaN(y)) {
                    alert('请填写完整信息');
                    return;
                }
                
                this.selectedMarker.name = name;
                this.selectedMarker.description = description;
                this.selectedMarker.image = image;
                this.selectedMarker.x = x;
                this.selectedMarker.y = y;
                
                this.renderAttractions();
                this.hideEditForm();
            }

            // 删除景点
            deleteAttraction() {
                if (!this.selectedMarker) return;
                
                if (confirm('确定要删除这个景点吗？')) {
                    this.attractions = this.attractions.filter(a => a.id !== this.selectedMarker.id);
                    this.renderAttractions();
                    this.hideEditForm();
                }
            }

            // 切换网格显示
            toggleGrid() {
                const grid = document.getElementById('gridOverlay');
                grid.classList.toggle('show');
            }

            // 更新坐标显示
            updateCoordinateDisplay(e) {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = ((e.clientX - rect.left - this.translateX) / this.scale / rect.width) * 100;
                const y = ((e.clientY - rect.top - this.translateY) / this.scale / rect.height) * 100;
                
                document.getElementById('coordinateDisplay').textContent = 
                    `坐标: (${Math.round(x * 10) / 10}%, ${Math.round(y * 10) / 10}%)`;
            }

            // 预览H5
            previewH5() {
                // 保存当前数据到H5端
                const h5Data = this.attractions.map(attraction => ({
                    id: attraction.id,
                    name: attraction.name,
                    description: attraction.description,
                    image: attraction.image,
                    coordinates: attraction.coordinates
                }));
                
                localStorage.setItem('h5_attractions', JSON.stringify(h5Data));
                window.open('../map.html', '_blank');
            }

            // 返回后台
            goBack() {
                window.location.href = '../admin/';
            }

            // 地图操作方法（复用H5端逻辑）
            initMap() {
                this.updateTransform();
            }

            handleMouseDown(e) {
                if (e.target.closest('.marker') || this.editMode === 'add') return;
                
                this.isDragging = true;
                this.startX = e.clientX - this.translateX;
                this.startY = e.clientY - this.translateY;
                document.getElementById('mapWrapper').classList.add('dragging');
                e.preventDefault();
            }

            handleMouseMove(e) {
                if (!this.isDragging) return;
                
                this.translateX = e.clientX - this.startX;
                this.translateY = e.clientY - this.startY;
                this.updateTransform();
                e.preventDefault();
            }

            handleMouseUp(e) {
                this.isDragging = false;
                document.getElementById('mapWrapper').classList.remove('dragging');
            }

            handleWheel(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.max(this.minScale, Math.min(this.maxScale, this.scale + delta));
                
                if (newScale !== this.scale) {
                    this.scale = newScale;
                    this.updateTransform();
                }
            }

            updateTransform() {
                const mapContent = document.getElementById('mapContent');
                mapContent.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;
                this.updateMarkerScale();
            }

            updateMarkerScale() {
                const markers = document.querySelectorAll('.marker');
                const markerScale = Math.max(0.6, Math.min(1.4, 1 / this.scale));
                
                markers.forEach(marker => {
                    marker.style.transform = `translate(-50%, -100%) scale(${markerScale})`;
                });
            }

            zoomIn() {
                if (this.scale < this.maxScale) {
                    this.scale = Math.min(this.maxScale, this.scale + 0.2);
                    this.updateTransform();
                }
            }

            zoomOut() {
                if (this.scale > this.minScale) {
                    this.scale = Math.max(this.minScale, this.scale - 0.2);
                    this.updateTransform();
                }
            }

            resetView() {
                this.scale = 1;
                this.translateX = 0;
                this.translateY = 0;
                this.updateTransform();
            }
        }

        // 初始化编辑器
        document.addEventListener('DOMContentLoaded', () => {
            new MapEditor();
        });
    </script>
</body>
</html>